<!doctype html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Morphera Admin Paneli</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
  /* =========================================================
        PREMIUM ADMIN PANEL CSS
        WeAreMorphera Gradient + Glassmorphism + Oval Cards
  ========================================================= */

  :root {
    --bg-dark: #0c0d14;
    --bg-light: #f7f9fc;

    --card-dark: rgba(255,255,255,0.06);
    --card-light: rgba(255,255,255,0.5);

    --text-dark: #ffffff;
    --text-light: #111111;

    --border-dark: rgba(255,255,255,0.16);
    --border-light: rgba(0,0,0,0.08);

    --gradient: linear-gradient(135deg,#6366f1,#8b5cf6,#ec4899);
    --gradient-soft: linear-gradient(160deg,rgba(99,102,241,0.35),rgba(236,72,153,0.28));
  }

  html[data-theme="dark"] {
    --bg: var(--bg-dark);
    --text: var(--text-dark);
    --card: var(--card-dark);
    --border: var(--border-dark);
  }
  html[data-theme="light"] {
    --bg: var(--bg-light);
    --text: var(--text-light);
    --card: var(--card-light);
    --border: var(--border-light);
  }

  * {
    box-sizing: border-box;
  }

  body {
  margin: 0;
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  font-family: "Inter",sans-serif;
}

  /* NAVBAR */
  .navbar {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 40px;
    background:linear-gradient(120deg,rgba(15,23,42,0.9),rgba(15,23,42,0.7));
    backdrop-filter:blur(22px);
    border-bottom:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 40px rgba(15,23,42,0.9);
    position:sticky;
    top:0;
    z-index:20;
  }
  .brand {
    display:flex;
    align-items:center;
    gap:14px;
    font-weight:700;
    font-size:22px;
  }
  .brand img {
    width:48px;
    height:48px;
    border-radius:18px;
    object-fit:cover;
    box-shadow:0 0 24px rgba(129,140,248,0.9);
  }
  .navbar-sub {
    font-size:13px;
    opacity:0.8;
  }

  .theme-toggle {
    padding:10px 22px;
    background:var(--gradient);
    border-radius:999px;
    border:none;
    color:#fff;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 15px 30px rgba(79,70,229,0.65);
  }

  /* LAYOUT */
  .wrapper {
    display:grid;
    grid-template-columns:260px minmax(0,1fr);
    gap:24px;
    padding:26px 32px 40px;
  }

  /* SIDEBAR */
  .sidebar {
    background:rgba(15,23,42,0.9);
    border-radius:24px;
    padding:22px 18px;
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 40px rgba(15,23,42,0.95);
    height:calc(100vh - 120px);
    position:sticky;
    top:80px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .sidebar-title{
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:0.16em;
    color:#9ca3af;
    margin-bottom:8px;
  }

  .menu-item{
    padding:12px 14px;
    margin-bottom:6px;
    border-radius:16px;
    border:1px solid transparent;
    color:#e5e7eb;
    font-size:14px;
    font-weight:500;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    transition:all .18s ease-out;
  }
  .menu-item span.icon{
    width:25px;
    height:25px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:15px;
  }
  .menu-item:hover{
    background:rgba(30,64,175,0.35);
  }
  .menu-item.active{
    background:var(--gradient);
    border-color:rgba(248,250,252,0.4);
    box-shadow:0 15px 40px rgba(129,140,248,0.8);
  }

  /* PANELS */
  .panel{
    display:none;
    background:rgba(15,23,42,0.9);
    border-radius:26px;
    padding:24px 26px 30px;
    border:1px solid rgba(148,163,184,0.45);
    box-shadow:0 20px 40px rgba(15,23,42,1);
  }
  .panel.active{display:block;}

  .panel-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:20px;
  }
  .panel-title{
    font-size:20px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .panel-title-badge{
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.6);
    color:#e5e7eb;
  }

  /* ANALYTICS */
  .analytics-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:18px;
  }
  .analytics-card{
    border-radius:22px;
    padding:18px 20px;
    background:radial-gradient(circle at top left,rgba(129,140,248,0.45),rgba(15,23,42,0.92));
    border:1px solid rgba(129,140,248,0.8);
    box-shadow:0 22px 50px rgba(55,65,81,0.9);
  }
  .analytics-label{
    font-size:14px;
    color:#e5e7eb;
  }
  .analytics-value{
    margin-top:6px;
    font-size:32px;
    font-weight:700;
    background:var(--gradient);
    -webkit-background-clip:text;
    color:transparent;
  }

  /* FORM GENEL */
  .form-grid{
    display:grid;
    grid-template-columns: minmax(0,2.2fr) minmax(0,1.8fr);
    gap:22px;
  }

  .field-group{
    margin-bottom:14px;
  }
  .field-label{
    display:block;
    font-size:13px;
    margin-bottom:6px;
    color:#e5e7eb;
  }
  input[type="text"],
  textarea{
    width:100%;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:14px;
    outline:none;
  }
  textarea{
    min-height:120px;
    resize:vertical;
  }
  input:focus,
  textarea:focus{
    border-color:#818cf8;
    box-shadow:0 0 0 1px rgba(129,140,248,0.6);
  }

  .btn-primary{
    border:none;
    border-radius:999px;
    background:var(--gradient);
    color:#fff;
    padding:10px 22px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 18px 42px rgba(129,140,248,0.9);
  }

  /* PROFƒ∞L PREVIEW */
  .profile-preview{
    border-radius:22px;
    padding:14px 14px 18px;
    background:radial-gradient(circle at top left,rgba(129,140,248,0.25),rgba(15,23,42,0.96));
    border:1px solid rgba(148,163,184,0.7);
  }
  .profile-cover{
    width:100%;
    height:150px;
    border-radius:18px;
    background:linear-gradient(135deg,#6366f1,#8b5cf6,#ec4899);
    background-size:cover;
    background-position:center;
  }
  .profile-avatar{
    width:96px;
    height:96px;
    border-radius:999px;
    margin-top:-46px;
    border:4px solid #020617;
    background:#111827;
    background-size:cover;
    background-position:center;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#f9fafb;
    font-weight:700;
    font-size:30px;
    box-shadow:0 18px 40px rgba(15,23,42,1);
  }
  .profile-meta{
    margin-top:12px;
  }
  .profile-name{
    font-size:16px;
    font-weight:600;
  }
  .profile-title{
    font-size:13px;
    color:#cbd5f5;
  }

  /* G√ñNDERƒ∞ Lƒ∞STESƒ∞ */
  .admin-post-card{
    border-radius:18px;
    padding:14px 16px;
    margin-bottom:12px;
    background:rgba(15,23,42,0.95);
    border:1px solid rgba(148,163,184,0.6);
  }
  .admin-post-meta{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:#9ca3af;
    margin-bottom:6px;
  }
  .admin-post-text{
    font-size:14px;
    color:#e5e7eb;
  }
  /* ========== ADMIN SOHBET ODASI ========== */

  .chat-layout{
    display:grid;
    grid-template-columns:minmax(0,2.2fr) minmax(0,1.2fr);
    gap:20px;
  }

  .chat-main{
    background:radial-gradient(circle at top left,rgba(129,140,248,0.25),rgba(15,23,42,0.96));
    border-radius:20px;
    border:1px solid rgba(148,163,184,0.6);
    padding:16px;
    display:flex;
    flex-direction:column;
    min-height:260px;
  }

  .chat-messages{
    flex:1;
    overflow-y:auto;
    padding:4px 4px 10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .chat-message{
    display:flex;
    align-items:flex-start;
    gap:10px;
    max-width:80%;
  }

  .chat-message--me{
    margin-left:auto;
    flex-direction:row-reverse;
  }

  .chat-avatar{
    width:38px;
    height:38px;
    border-radius:999px;
    background:#111827;
    background-size:cover;
    background-position:center;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:600;
    color:#f9fafb;
    box-shadow:0 8px 18px rgba(15,23,42,0.9);
  }

  .chat-bubble{
    padding:10px 12px;
    border-radius:16px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.6);
    font-size:14px;
    color:#e5e7eb;
    position:relative;
  }

  .chat-message--me .chat-bubble{
    background:var(--gradient);
    border-color:rgba(248,250,252,0.5);
  }

  .chat-meta{
    font-size:11px;
    opacity:0.7;
    margin-bottom:4px;
  }

  .chat-delete{
    position:absolute;
    bottom:4px;
    right:6px;
    font-size:11px;
    opacity:0.6;
    cursor:pointer;
  }

  .chat-delete:hover{
    opacity:1;
  }

  .chat-input-row{
    margin-top:12px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  #chatInput{
    flex:1;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:#020617;
    color:#e5e7eb;
    padding:10px 14px;
    font-size:14px;
    outline:none;
  }

  #chatInput:focus{
    border-color:#818cf8;
    box-shadow:0 0 0 1px rgba(129,140,248,0.7);
  }

  .chat-send-btn{
    border:none;
    border-radius:999px;
    padding:10px 20px;
    background:var(--gradient);
    color:#fff;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    box-shadow:0 14px 30px rgba(129,140,248,0.9);
  }

  .chat-side{
    background:rgba(15,23,42,0.96);
    border-radius:20px;
    border:1px solid rgba(148,163,184,0.6);
    padding:16px;
  }

  .chat-side-title{
    margin:0 0 4px;
    font-size:16px;
    font-weight:600;
  }

  .chat-side-subtitle{
    margin:0 0 12px;
    font-size:13px;
    color:#9ca3af;
  }

  .chat-members{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .chat-member{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 8px;
    border-radius:10px;
    background:rgba(15,23,42,0.9);
  }

  .chat-member-dot{
    width:8px;
    height:8px;
    border-radius:999px;
    margin-right:4px;
  }

  .chat-member-name{
    font-size:13px;
  }

  .chat-member-role{
    font-size:11px;
    color:#9ca3af;
  }

  @media (max-width: 960px){
    .chat-layout{
      grid-template-columns:minmax(0,1fr);
    }
  }

  @media (max-width: 960px){
    .wrapper{
      grid-template-columns: minmax(0,1fr);
    }
    .sidebar{
      position:static;
      height:auto;
      flex-direction:row;
      overflow-x:auto;
    }
    .sidebar-title{display:none;}
  }
    /* ============ ADMIN SOHBET ODASI ============ */
  .chat-layout{
    display:grid;
    grid-template-columns:minmax(0,2.2fr) minmax(0,1.2fr);
    gap:20px;
  }
  .chat-box{
    border-radius:22px;
    padding:16px 16px 18px;
    background:radial-gradient(circle at top left,rgba(129,140,248,0.22),rgba(15,23,42,0.97));
    border:1px solid rgba(148,163,184,0.7);
    display:flex;
    flex-direction:column;
    min-height:260px;
    max-height:520px;
  }
  .chat-messages{
    flex:1;
    overflow-y:auto;
    padding-right:4px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .chat-message{
    max-width:78%;
    padding:10px 12px;
    border-radius:18px;
    position:relative;
    font-size:13px;
    line-height:1.4;
  }
  .chat-message.me{
    margin-left:auto;
    background:linear-gradient(135deg,#6366f1,#ec4899);
    color:#fff;
    border-bottom-right-radius:4px;
  }
  .chat-message.other{
    margin-right:auto;
    background:rgba(15,23,42,0.95);
    border:1px solid rgba(148,163,184,0.7);
    border-bottom-left-radius:4px;
  }
  .chat-message-header{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:4px;
    font-size:12px;
    opacity:.9;
  }
  .chat-avatar{
    width:26px;
    height:26px;
    border-radius:999px;
    background:#020617;
    background-size:cover;
    background-position:center;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:600;
    color:#e5e7eb;
    box-shadow:0 8px 18px rgba(15,23,42,0.85);
  }
  .chat-meta{
    font-size:11px;
    opacity:.75;
    margin-top:4px;
    display:flex;
    justify-content:space-between;
    gap:8px;
  }
  .chat-input-row{
    margin-top:12px;
    display:flex;
    gap:10px;
  }
  .chat-input-row input{
    flex:1;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.7);
    background:rgba(15,23,42,0.95);
    color:#e5e7eb;
    padding:10px 14px;
    font-size:14px;
    outline:none;
  }

  .chat-members{
    border-radius:22px;
    padding:14px;
    background:radial-gradient(circle at top,rgba(129,140,248,0.25),rgba(15,23,42,0.98));
    border:1px solid rgba(148,163,184,0.7);
    max-height:520px;
    overflow-y:auto;
  }
  .chat-member{
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px 6px;
    border-radius:12px;
  }
  .chat-member-main{
    flex:1;
  }
  .chat-member-name{
    font-size:13px;
    font-weight:600;
  }
  .chat-member-title{
    font-size:11px;
    color:#9ca3af;
  }
  .chat-status-dot{
    width:8px;
    height:8px;
    border-radius:999px;
    background:#22c55e;
    box-shadow:0 0 0 4px rgba(34,197,94,0.32);
  }
  .chat-status-text{
    font-size:11px;
    color:#9ca3af;
  }
  .chat-delete{
    background:none;
    border:none;
    color:rgba(248,250,252,0.9);
    font-size:11px;
    cursor:pointer;
    padding:0;
    margin-left:4px;
    opacity:.7;
  }
  .chat-delete:hover{
    opacity:1;
    text-decoration:underline;
  }

    @media (max-width: 960px){
    .chat-layout{
      grid-template-columns:minmax(0,1fr);
    }
    .chat-main{
      padding:12px;
      min-height:220px;
    }
    .chat-side{
      margin-top:12px;
    }
  }

  @media (max-width: 640px){
    .panel-header{
      flex-direction:column;
      align-items:flex-start;
      gap:8px;
    }

    .chat-messages{
      max-height:320px;
    }

    .chat-input-row{
      flex-direction:column;
      align-items:stretch;
    }

    #chatInput{
      width:100%;
    }

    .chat-send-btn{
      width:100%;
      text-align:center;
      box-shadow:0 10px 24px rgba(129,140,248,0.9);
    }

    .chat-side{
      padding:12px;
    }

    .chat-status{
      flex-direction:column;
      align-items:flex-start;
    }

    #chatStatusSelect{
      width:100%;
    }
  }

  .chat-status{
    margin-bottom:14px;
    padding:8px 10px;
    border-radius:12px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.6);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }

  .chat-status label{
    font-size:12px;
    color:#e5e7eb;
  }

  #chatStatusSelect{
    flex:0 0 auto;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
    background:#020617;
    color:#e5e7eb;
    font-size:12px;
    padding:4px 10px;
    outline:none;
  }
.chat-emoji-btn{
  border:none;
  width:42px;
  height:42px;
  border-radius:999px;
  background:rgba(15,23,42,0.95);
  color:#f9fafb;
  font-size:20px;
  cursor:pointer;
  box-shadow:0 8px 24px rgba(15,23,42,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
}

.emoji-panel{
  display:none;
  margin-top:6px;
  padding:8px 10px;
  border-radius:14px;
  background:rgba(15,23,42,0.96);
  border:1px solid rgba(148,163,184,0.4);
  max-width:480px;
  font-size:20px;
  line-height:1.8;
  flex-wrap:wrap;
}

.emoji-panel span{
  cursor:pointer;
  margin:2px 4px;
}

.emoji-panel.open{
  display:flex;
}

/* Tik (okundu bilgisi) stilleri */
.tick{
  font-size:12px;
}

.tick--single{
  color:#ff0000;   /* Gri tek tik */
}

.tick--double{
  color:#0800ff;   /* Mavi √ßift tik */
  letter-spacing:-2px;
}
/* ------ Sabitlenmi≈ü mesaj barƒ± ------ */
.pinned-bar{
  margin-bottom:10px;
  padding:10px 14px;
  border-radius:18px;
  background:linear-gradient(120deg,#6366f1,#ec4899);
  box-shadow:0 0 18px rgba(236,72,153,0.6), 0 0 40px rgba(129,140,248,0.6);
  color:#fff;
  font-size:13px;
  display:flex;
  align-items:flex-start;
  gap:10px;
  position:relative;
  overflow:hidden;
}

.pinned-bar::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:conic-gradient(from 0deg,rgba(255,255,255,0.1),transparent,rgba(255,255,255,0.2));
  animation:pinnedGlow 4s linear infinite;
  opacity:.6;
}

@keyframes pinnedGlow{
  0%   { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

.pinned-bar-content{
  position:relative;
  z-index:1;
}

.pinned-bar-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.14em;
  opacity:.9;
  margin-bottom:4px;
}

.pinned-bar-text{
  font-size:13px;
}

/* Pin butonu */
.chat-pin{
  background:none;
  border:none;
  font-size:11px;
  color:#fde68a;
  cursor:pointer;
  margin-left:6px;
  padding:0;
}

.chat-pin:hover{
  text-decoration:underline;
}

/* Arama kutusu */
.chat-search{
  display:flex;
  align-items:center;
  gap:6px;
}

.chat-search input{
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.7);
  background:#020617;
  color:#e5e7eb;
  padding:6px 12px;
  font-size:12px;
  outline:none;
  min-width:180px;
}

.chat-search input:focus{
  border-color:#818cf8;
  box-shadow:0 0 0 1px rgba(129,140,248,0.7);
}

/* Arama sonucu highlight */
.chat-search-mark{
  background:rgba(251,191,36,0.2);
  padding:0 2px;
  border-radius:4px;
}

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
  <div class="brand">
    <img src="assets/img/logo/morphera.png" alt="Morphera">
    <div>
      <div>WeAreMorphera ‚Äì Admin Paneli</div>
      <div class="navbar-sub">Morpheradan Notlar ¬∑ ƒ∞√ßerik & Profil Y√∂netimi</div>
    </div>
  </div>
<div id="notifDot" style="width:12px;height:12px;background:#ff1744;border-radius:50%;display:none;margin-left:12px;"></div>

  <button id="themeToggle" class="theme-toggle">
    üåó Tema Deƒüi≈ütir
  </button>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</header>

<main class="wrapper">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-title">Panel</div>
<div class="menu-item" data-panel="schedulePanel" onclick="showPanel('schedulePanel')">
  <span class="icon lottie" data-json="assets/img/admin/zaman.json"></span> Zamanlanmƒ±≈ü
</div>

<div class="menu-item" data-panel="commentsPanel" onclick="showPanel('commentsPanel')">
  <span class="icon lottie" data-json="assets/img/admin/yorum.json"></span> Yorumlar
</div>



    <div class="menu-item active" data-panel="analyticsPanel" onclick="showPanel('analyticsPanel')">
  <span class="icon lottie" data-json="assets/img/admin/analiz.json"></span> Analytics
</div>
   <div class="menu-item" data-panel="profilePanel" onclick="showPanel('profilePanel')">
  <span class="icon lottie" data-json="assets/img/admin/profil3.json"></span> Profil Ayarlarƒ±
</div>

<div class="menu-item" data-panel="newPostPanel" onclick="showPanel('newPostPanel')">
  <span class="icon lottie" data-json="assets/img/admin/g√∂nderi.json"></span> Yeni G√∂nderi
</div>

<div class="menu-item" data-panel="postsPanel" onclick="showPanel('postsPanel')">
  <span class="icon lottie" data-json="assets/img/admin/g√∂nderi.json"></span> G√∂nderiler
</div>

<!-- üî• YENƒ∞: Sohbet Odasƒ± men√º maddesi -->
<div class="menu-item" data-panel="chatPanel" onclick="showPanel('chatPanel')">
  <span class="icon lottie" data-json="assets/img/admin/sohbet.json"></span> Sohbet Odasƒ±
</div>

<div class="menu-item" style="margin-top:auto;background:#ff1744cc;border:1px solid #ff8a80;" onclick="logoutAdmin()">
  <span class="icon lottie" data-json="assets/img/admin/√ßƒ±kƒ±≈ü.json"></span> √áƒ±kƒ±≈ü Yap
</div>


  </aside>

  <!-- PANELS WRAPPER -->
  <section>
<section class="panel" id="commentsPanel">
  <div class="panel-header">
    <div class="panel-title">
      üí¨ Yorum Y√∂netimi
      <span class="panel-title-badge">T√ºm G√∂nderiler</span>
    </div>
  </div>

  <div id="commentsList"></div>
</section>
<section class="panel" id="schedulePanel">
  <div class="panel-header">
    <div class="panel-title">
      ‚è∞ Zamanlanmƒ±≈ü G√∂nderiler
      
    </div>
  </div>

  <div id="scheduledList"></div>
</section>

    <!-- ANALYTICS -->
    <section class="panel active" id="analyticsPanel">
      <div class="panel-header">
        <div class="panel-title">
          üìä Analytics
          <span class="panel-title-badge">Duvar √ñzeti</span>
        </div>
      </div>

      <div class="analytics-grid">
        <article class="analytics-card">
          <div class="analytics-label">Toplam G√∂nderi</div>
          <div class="analytics-value" id="statPosts">0</div>
        </article>

        <article class="analytics-card">
          <div class="analytics-label">Toplam Beƒüeni</div>
          <div class="analytics-value" id="statLikes">0</div>
        </article>

        <article class="analytics-card">
          <div class="analytics-label">Toplam Yorum</div>
          <div class="analytics-value" id="statComments">0</div>
        </article>
      </div>
      <canvas id="chartPosts" height="120"></canvas>
    </section>

    <!-- PROFƒ∞L -->
       <!-- PROFƒ∞L -->
    <section class="panel" id="profilePanel">
      <div class="panel-header">
        <div class="panel-title">
          üë§ Profil Ayarlarƒ±
          <span class="panel-title-badge">Yazar Kartƒ±n</span>
        </div>
      </div>

      <div class="form-grid">
        <!-- FORM -->
        <form id="profileForm">
          <div class="field-group">
            <label class="field-label">Ad Soyad</label>
            <input id="profileDisplayName" type="text" placeholder="√ñrn: Bulut Kele≈ü">
          </div>

          <div class="field-group">
            <label class="field-label">√únvan / Rol</label>
            <input id="profileTitle" type="text" placeholder="Co-Founder ¬∑ Tech & Growth">
          </div>

          <div class="field-group">
            <label class="field-label">Profil Fotoƒürafƒ± (dosya y√ºkle)</label>
            <input id="profileAvatarFile" type="file" accept="image/*">
          </div>

          <div class="field-group">
            <label class="field-label">Kapak Fotoƒürafƒ± (dosya y√ºkle)</label>
            <input id="profileCoverFile" type="file" accept="image/*">
          </div>

          <button class="btn-primary" type="submit">Profili Kaydet</button>
        </form>

        <!-- PREVIEW -->
        <aside class="profile-preview">
          <div id="profileCoverPreview" class="profile-cover"></div>
          <div id="profileAvatarPreview" class="profile-avatar">WM</div>

          <div class="profile-meta">
            <div class="profile-name" id="previewName">WeAreMorphera</div>
            <div class="profile-title" id="previewTitle">Admin</div>
          </div>
        </aside>
      </div>
    </section>


    <!-- YENƒ∞ G√ñNDERƒ∞ -->
    <section class="panel" id="newPostPanel">
      <div class="panel-header">
        <div class="panel-title">
          üìù Yeni G√∂nderi
          <span class="panel-title-badge">Morpheradan Notlar</span>
        </div>
      </div>

      <form id="postForm">
        <div class="field-group">
          <label class="field-label">G√∂nderi Metni</label>
          <textarea id="postText" placeholder="Kƒ±sa, net, i√ßten bir not yaz..."></textarea>
        </div>
<div class="field-group">
  <label class="field-label">Zamanlama (opsiyonel)</label>

  <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <input type="checkbox" id="scheduleEnable">
    Zamanlama Kullan (Yakƒ±nda aktif olacak)
  </label>

  <div id="scheduleFields" style="display:none;gap:10px;flex-wrap:wrap;">

    <input id="scheduleDate" type="date"
      style="padding:10px;border-radius:10px;border:1px solid #555;background:#0f172a;color:white;">

    <input id="scheduleTime" type="time"
      style="padding:10px;border-radius:10px;border:1px solid #555;background:#0f172a;color:white;">

  </div>
</div>

<script>
document.getElementById("scheduleEnable").addEventListener("change", function() {
  document.getElementById("scheduleFields").style.display = this.checked ? "flex" : "none";
});
</script>


        <div class="field-group">
          <label class="field-label">G√∂rsel URL (opsiyonel)</label>
          <input id="postImageUrl" type="text" placeholder="https://... .webp / .jpg">
        </div>

        <button class="btn-primary" type="submit">G√∂nderiyi Payla≈ü</button>
      </form>
    </section>
    <!-- SOHBET ODASI -->
    <section class="panel" id="chatPanel">
      <div class="panel-header">
        <div class="panel-title">
          üí¨ Admin Sohbet Odasƒ±
          <span class="panel-title-badge">Canlƒ± ¬∑ Morpheradan Notlar Ekibi</span>
        </div>
      </div>

      <div class="chat-layout">
        <!-- SOL: Mesajlar -->
        <div class="chat-box">
            <!-- üìå Sabitlenmi≈ü mesaj alanƒ± -->
<div id="pinnedMessageBar"></div>



          <div class="chat-messages" id="chatMessages"></div>

         <form id="chatForm" class="chat-input-row">
  <button type="button" id="emojiToggle" class="chat-emoji-btn">üòä</button>

  <input id="chatInput" type="text"
         placeholder="Odadan ekibe kƒ±sa bir not bƒ±rak..."
         autocomplete="off" />

  <button class="chat-send-btn" type="submit">G√∂nder</button>
</form>

<!-- Emoji paneli -->
<div id="emojiPanel" class="emoji-panel">
  üòÄ üòÉ üòÑ üòÖ üòÇ ü§î üôå ‚ú® ‚ù§Ô∏è üî• üòé üòç üò¥ üòá üò¢ üò°
</div>

        </div>

        <!-- SAƒû: √úye listesi + oda y√∂neticisi ara√ßlarƒ± -->
        <aside class="chat-members">
          <h3 style="margin:0 0 10px;font-size:14px;">Grup √úyeleri</h3>
          <p style="margin:0 0 12px;font-size:12px;color:#9ca3af;">
            Bu odadaki adminler Morpheradan Notlar duvarƒ±nƒ± birlikte y√∂netir.
          </p>
 <!-- ‚≠ê Yeni: kendi durumun -->
  <div class="chat-status">
    <label for="chatStatusSelect">Senin durumun</label>
    <select id="chatStatusSelect">
      <option value="online">√áevrim i√ßi</option>
      <option value="busy">M√ºsait deƒüil</option>
      <option value="offline">√áevrim dƒ±≈üƒ±</option>
    </select>
  </div>
          <div id="chatMembers"></div>

          <!-- Sadece Bulut (oda sahibi) g√∂recek -->
          <div id="chatOwnerBox"
               style="margin-top:14px;padding-top:10px;border-top:1px dashed rgba(148,163,184,0.6);display:none;">
            <label style="font-size:11px;color:#9ca3af;display:block;margin-bottom:6px;">
              Yeni √ºye ekle (kullanƒ±cƒ± adƒ±)
            </label>
            <div style="display:flex;gap:8px;">
              <input id="chatNewMember" type="text" placeholder="busrakaraca"
                     style="flex:1;border-radius:999px;border:1px solid rgba(148,163,184,0.7);background:#020617;color:#e5e7eb;padding:8px 12px;font-size:12px;">
              <button id="chatAddMemberBtn" type="button"
                      class="btn-primary" style="padding-inline:14px;font-size:12px;">
                Ekle
              </button>
            </div>
            <p style="margin-top:6px;font-size:11px;color:#9ca3af;">
              Eklediƒüin ki≈üi admin paneline girdiƒüinde sohbeti g√∂recek.
            </p>
          </div>
        </aside>
      </div>
    </section>

    <!-- G√ñNDERƒ∞LER -->
    <section class="panel" id="postsPanel">
      <div class="panel-header">
        <div class="panel-title">
          üß± G√∂nderiler
          <span class="panel-title-badge">Sadece Senin Notlarƒ±n</span>
        </div>
      </div>

      <div id="postList"></div>
    </section>

  </section>
</main>

<!-- FIREBASE + PANEL JS -->
<!-- FIREBASE + ADMIN PANEL JS -->
<!-- FIREBASE + ADMIN PANEL JS -->
<script type="module">
    // ==== LOTTIE ICON LOADER ====
document.querySelectorAll(".lottie").forEach(el => {
  const anim = lottie.loadAnimation({
    container: el,
    renderer: "svg",
    loop: true,
    autoplay: true,
    path: el.dataset.json
  });

  el.animation = anim;
});
import { updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

async function markMessagesAsRead(docs) {
  if (!username) return;

  const updates = docs.map(d => {
    const data   = d.data();
    const readBy = data.readBy || {};

    // Zaten bu kullanƒ±cƒ± okunmu≈ü olarak i≈üaretliyse ge√ß
    if (readBy[username]) return null;

    const newReadBy = {
      ...readBy,
      [username]: true   // bu admin de okudu
    };

    return updateDoc(d.ref, {
      readBy: newReadBy   // komple map'i g√ºncelliyoruz
    });
  }).filter(Boolean);

  if (updates.length) {
    try {
      await Promise.all(updates);
    } catch (err) {
      console.error("okundu bilgisi g√ºncellenirken hata:", err);
    }
  }
}


  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    setDoc,
    addDoc,
    getDocs,
    query,
    orderBy,
    serverTimestamp,
      where
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
  import { deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { Timestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
window.logoutAdmin = function() {
  localStorage.removeItem("morpheraAdminUser");
  window.location.href = "notes.html";
};




  // ---- Tema Toggle ----
  const savedTheme = localStorage.getItem("morpheraAdminTheme") || "dark";
  document.documentElement.setAttribute("data-theme", savedTheme);

  const themeBtn = document.getElementById("themeToggle");
  if (themeBtn) {
    themeBtn.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      const next = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("morpheraAdminTheme", next);
    });
  }

  // ---- Panel Deƒüi≈ütirme ----
  const panels = document.querySelectorAll(".panel");
  const menuItems = document.querySelectorAll(".menu-item");

  window.showPanel = function(panelId) {
    panels.forEach(p => p.classList.toggle("active", p.id === panelId));
    menuItems.forEach(item => {
      item.classList.toggle("active", item.dataset.panel === panelId);
    });
  };

  // ---- Firebase ----
  const firebaseConfig = {
    apiKey: "AIzaSyCoLU3FES5QdNoD1WOHz9M7Z01U63hkn4U",
    authDomain: "morpheranotes.firebaseapp.com",
    projectId: "morpheranotes",
    storageBucket: "morpheranotes.appspot.com",
    messagingSenderId: "756772520204",
    appId: "1:756772520204:web:b686f9f69f860098a10929",
    measurementId: "G-CLH7TE7TNP"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const notesColRef   = collection(db, "morpheraNotes");
  const authorsColRef = collection(db, "noteAuthors");
    const chatColRef     = collection(db, "adminChatMessages");
  const chatMembersRef = collection(db, "adminChatMembers");
  

  // ---- Giri≈ü yapan admin bilgisi ----
  const username = localStorage.getItem("morpheraAdminUser");
  if (!username) {
    window.location.href = "notes.html";
  }

  const authorDocRef = doc(authorsColRef, username);

  // ---- DOM Referanslarƒ± ----
  const displayNameInput = document.getElementById("profileDisplayName");
  const titleInput       = document.getElementById("profileTitle");
  const avatarFileInput  = document.getElementById("profileAvatarFile");
  const coverFileInput   = document.getElementById("profileCoverFile");

  const avatarPreview    = document.getElementById("profileAvatarPreview");
  const coverPreview     = document.getElementById("profileCoverPreview");
  const previewName      = document.getElementById("previewName");
  const previewTitle     = document.getElementById("previewTitle");

  const profileForm      = document.getElementById("profileForm");

  const postForm         = document.getElementById("postForm");
  const postTextInput    = document.getElementById("postText");
  const postImageInput   = document.getElementById("postImageUrl");
  const postList         = document.getElementById("postList");
  
  const chatOwnerBox     = document.getElementById("chatOwnerBox");
  const chatNewMemberInp = document.getElementById("chatNewMember");
  const chatAddMemberBtn = document.getElementById("chatAddMemberBtn");

  const statPostsEl      = document.getElementById("statPosts");
  const statLikesEl      = document.getElementById("statLikes");
  const statCommentsEl   = document.getElementById("statComments");
  const chatMessagesEl = document.getElementById("chatMessages");
  const pinnedBarEl     = document.getElementById("pinnedMessageBar");
const chatSearchInput = document.getElementById("chatSearchInput");

let lastChatDocs      = [];   // snapshot‚Äôƒ± burada tutacaƒüƒ±z
let currentSearchTerm = "";   // arama kelimesi

  // Kendi balonuna tƒ±klayƒ±nca okuyanlarƒ± g√∂ster
chatMessagesEl.addEventListener("click", (e) => {
  const bubble = e.target.closest(".chat-bubble");
  if (!bubble) return;

  const parent = bubble.parentElement;
  const isMine = parent && parent.classList.contains("chat-message--me");
  if (!isMine) return;

  const readers = JSON.parse(bubble.dataset.readers || "[]");
  if (!readers.length) {
    alert("Bu mesajƒ± hen√ºz sadece sen okudun.");
    return;
  }

  const nameMap = {
    bulutkeles: "Bulut Kele≈ü",
    busrakaraca: "B√º≈üra Karaca",
    eminekaraca: "Emine Karaca"
  };

  const pretty = readers.map(r => nameMap[r] || r).join(", ");
  alert("Bu mesajƒ± okuyanlar: " + pretty);
});

  const chatMembersEl  = document.getElementById("chatMembers");
  const chatForm       = document.getElementById("chatForm");
  const chatInput      = document.getElementById("chatInput");
// Yeni mesaj sesi i√ßin
let chatInitialized = false;  // ilk y√ºklemede eski mesajlar i√ßin ses √ßalmasƒ±n

function playChatSound() {
  const audio = document.getElementById("chatSound");
  if (!audio) return;
  audio.currentTime = 0;
  audio.play().catch(() => {
    // mobilde kullanƒ±cƒ± hen√ºz etkile≈üim vermediyse hata atabilir, g√∂rmezden geliyoruz
  });
} 
// üîì Tarayƒ±cƒ± ses kilidini a√ßmak i√ßin ‚Äì ilk tƒ±klamada sessizce √ßal/pause
document.addEventListener("click", function unlockSound() {
  const audio = document.getElementById("chatSound");
  if (!audio) return;

  audio.play().then(() => {
    audio.pause();
    audio.currentTime = 0;
    document.removeEventListener("click", unlockSound);
  }).catch(() => {
    // engellenirse sorun deƒüil, sonraki tƒ±klamada tekrar dener
  });
}, { once: true });

const emojiToggle = document.getElementById("emojiToggle");
// üîç Arama kutusu dinleyicisi
if (chatSearchInput) {
  chatSearchInput.addEventListener("input", (e) => {
    currentSearchTerm = (e.target.value || "").trim().toLowerCase();
    renderChatMessages();   // aynƒ± datadan yeniden HTML √ºret
  });
}

const emojiPanel  = document.getElementById("emojiPanel");
if (emojiToggle && emojiPanel && chatInput) {
  emojiToggle.addEventListener("click", () => {
    emojiPanel.classList.toggle("open");
  });

  emojiPanel.innerHTML = emojiPanel.textContent
    .split(" ")
    .filter(Boolean)
    .map(e => `<span>${e}</span>`)
    .join("");

  emojiPanel.addEventListener("click", (e) => {
    const span = e.target.closest("span");
    if (!span) return;
    chatInput.value += span.textContent;
    chatInput.focus();
  });

  // input odaktan √ßƒ±kƒ±nca paneli kapat
  chatInput.addEventListener("blur", () => {
    setTimeout(() => emojiPanel.classList.remove("open"), 150);
  });
}

  let currentProfile = null;
let chatStatus = "online";
  function defaultProfile(username) {
    if (username === "bulutkeles") {
      return { displayName: "Bulut Kele≈ü", title: "Co-Founder ¬∑ Tech & Growth", avatarUrl: "", coverUrl: "" };
    }
    if (username === "busrakaraca") {
      return { displayName: "B√º≈üra Karaca", title: "Co-Founder ¬∑ Creative & Ops", avatarUrl: "", coverUrl: "" };
    }
    if (username === "eminekaraca") {
      return { displayName: "Emine Karaca", title: "Community & Content", avatarUrl: "", coverUrl: "" };
    }
    return { displayName: username, title: "", avatarUrl: "", coverUrl: "" };
  }
  // üî• Sohbet i√ßin varsayƒ±lan √ºyeler
  async function ensureDefaultChatMembers() {
  const baseUsers = ["bulutkeles","busrakaraca","eminekaraca"];

  await Promise.all(
    baseUsers.map(async (u) => {
      const ref  = doc(chatMembersRef, u);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        const def = defaultProfile(u);
        await setDoc(ref, {
          username: u,
          displayName: def.displayName,
          title: def.title,
          avatarUrl: def.avatarUrl || "",
          isAdmin: u === "bulutkeles",
          status: "offline"          // ‚≠ê ilk kurulumda herkes offline
        }, { merge:true });
      }
    })
  );
}


  // Giri≈ü yapan adminin profilini sohbet √ºyelerine yansƒ±t
  async function syncMyChatMemberDoc() {
  if (!currentProfile) return;
  const ref = doc(chatMembersRef, username);
  await setDoc(ref, {
    username,
    displayName: currentProfile.displayName || username,
    title: currentProfile.title || "",
    avatarUrl: currentProfile.avatarUrl || "",
    isAdmin: username === "bulutkeles",
    status: chatStatus,              // ‚≠ê se√ßilen durum
    lastSeen: serverTimestamp()
  }, { merge:true });
}


  // Presence (√ßevrim i√ßi / dƒ±≈üƒ±)
  async function updatePresence() {
  try {
    await setDoc(doc(chatMembersRef, username), {
      status: chatStatus,            // ‚≠ê status alanƒ±
      lastSeen: serverTimestamp()
    }, { merge:true });
  } catch(e){ console.warn("Presence hatasƒ±:", e); }
}


  function startPresenceHeartbeat() {
    updatePresence();
    setInterval(updatePresence, 60_000); // her 1 dakikada bir
  }

    function subscribeChatMembers() {
  onSnapshot(chatMembersRef, (snap) => {
    const now = new Date();
    const items = [];

    snap.forEach(ds => {
      const m = ds.data();

      let statusText = "√áevrim dƒ±≈üƒ±";
      let dotColor   = "#64748b";

      if (m.lastSeen && m.lastSeen.toDate) {
        const diff = now - m.lastSeen.toDate();
        const isActive = diff < 3 * 60 * 1000; // son 3 dk i√ßinde hareket

        if (isActive) {
          if (m.status === "online") {
            statusText = "√áevrim i√ßi";
            dotColor   = "#22c55e";
          } else if (m.status === "busy") {
            statusText = "M√ºsait deƒüil";
            dotColor   = "#f97316";
          } else {
            statusText = "√áevrim dƒ±≈üƒ±";
            dotColor   = "#64748b";
          }
        }
      }

      items.push(`
        <div class="chat-member">
          <div class="chat-member-dot" style="background:${dotColor};"></div>
          <div>
            <div class="chat-member-name">${m.displayName || m.username}</div>
            <div class="chat-member-role">
              ${m.isAdmin ? "Admin ¬∑ " : ""}${statusText}
            </div>
          </div>
        </div>
      `);
    });

    chatMembersEl.innerHTML = items.join("") || "<p>Hen√ºz √ºye yok.</p>";
  });
}


 // üîÅ Mesajlarƒ± HTML'e √ßeviren fonksiyon
function renderChatMessages() {
  const parts = [];
  let pinnedHtml = "";

  lastChatDocs.forEach(({ id, data: m }) => {
    const ownerUsername = m.username || m.authorKey || "";
    const displayName   = m.displayName || m.authorName || ownerUsername;
    const avatarUrl     = m.avatarUrl || m.authorAvatar || "";
    const isMe          = ownerUsername === username;
    const isPinned      = !!m.pinned;

    const date = m.createdAt?.toDate?.() || new Date();
    const ts = date.toLocaleString("tr-TR", {
      day:"2-digit", month:"2-digit", year:"numeric",
      hour:"2-digit", minute:"2-digit"
    });

    const initials = (displayName || ownerUsername || "?")
      .split(" ")
      .map(p => p.charAt(0))
      .join("")
      .slice(0,2)
      .toUpperCase();

    const avatarStyle = avatarUrl
      ? `background-image:url('${avatarUrl}');`
      : "";

    const canDelete = isMe || username === "bulutkeles";
    const canPin    = username === "bulutkeles";

    // Okundu bilgisi
    const readBy  = m.readBy || {};
    const readers = Object.keys(readBy).filter(u => u !== username);

    let ticksHtml = "";
    if (isMe) {
      if (readers.length === 0) {
        ticksHtml = `<span class="tick tick--single">‚úì</span>`;
      } else {
        ticksHtml = `<span class="tick tick--double">‚úì‚úì</span>`;
      }
    }

    // üîç Arama highlight
    const plainText = m.text || "";
    let messageHtml;

    if (currentSearchTerm && plainText.toLowerCase().includes(currentSearchTerm)) {
      const safeTerm = currentSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const r        = new RegExp(safeTerm, "gi");
      const marked   = plainText.replace(r, match => `<span class="chat-search-mark">${match}</span>`);
      messageHtml    = marked.replace(/\n/g,"<br>");
    } else {
      messageHtml    = plainText.replace(/\n/g,"<br>");
    }

    // üìå Pin butonu text'i
let pinHtml = "";
if (canPin) {
  pinHtml = `
    <button class="chat-pin"
            onclick="event.stopPropagation(); togglePinChatMessage('${id}', ${isPinned ? "true" : "false"})">
      ${isPinned ? "üìå Sabitlemeyi kaldƒ±r" : "üìå Sabitle"}
    </button>
  `;
}


    const deleteHtml = canDelete
  ? `<span class="chat-delete"
           onclick="event.stopPropagation(); deleteChatMessage('${id}','${ownerUsername}')">
       Sil
     </span>`
  : "";


    const bubbleHtml = `
      <div class="chat-message ${isMe ? "chat-message--me" : ""}">
        <div class="chat-avatar" style="${avatarStyle}">
          ${avatarUrl ? "" : initials}
        </div>
        <div class="chat-bubble"
             data-owner='${ownerUsername}'>
          <div class="chat-meta">
            <strong>${displayName}</strong> ¬∑ ${ts}
            ${ticksHtml}
          </div>
          <div>${messageHtml}</div>
          <div class="chat-meta chat-meta-bottom">
  <span>
    ${pinHtml}
  </span>
  <span>
    ${deleteHtml}
  </span>
</div>

        </div>
      </div>
    `;

    parts.push(bubbleHtml);

    // Sabitli mesaj i√ßin ayrƒ± bar
    if (isPinned) {
      pinnedHtml = `
        <div class="pinned-bar">
          <div class="pinned-bar-content">
            <div class="pinned-bar-title">Sabitlenmi≈ü Mesaj</div>
            <div class="pinned-bar-text">
              <strong>${displayName}:</strong> ${plainText}
            </div>
          </div>
        </div>
      `;
    }
  });

  chatMessagesEl.innerHTML = parts.join("") || "<p>Hen√ºz mesaj yok. ƒ∞lk mesajƒ± sen yaz. üòä</p>";
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

  pinnedBarEl.innerHTML = pinnedHtml;
}

// üîî Firestore snapshot aboneliƒüi
function subscribeChatMessages() {
  const qChat = query(chatColRef, orderBy("createdAt","asc"));

  onSnapshot(qChat, (snap) => {
    // okunma bilgisi
    markMessagesAsRead(snap.docs);

    // dok√ºmanlarƒ± global deƒüi≈ükende tut
    lastChatDocs = snap.docs.map(ds => ({
      id:   ds.id,
      data: ds.data()
    }));

    // G√ºncel arama terimine g√∂re yeniden √ßiz
    renderChatMessages();
  });
}




  // Mesaj g√∂nderme
  if (chatForm) {
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();                     // üî• Artƒ±k hi√ßbir yere y√∂nlenmiyor
      const text = (chatInput.value || "").trim();
      if (!text) return;

      if (!currentProfile) { await loadProfile(); }

    await addDoc(chatColRef, {
  text,
  username: username,
  displayName: currentProfile.displayName || username,
  avatarUrl: currentProfile.avatarUrl || "",
  createdAt: serverTimestamp(),
  readBy: {
    [username]: true   // g√∂nderen otomatik okumu≈ü
  }
});



      chatInput.value = "";
    });
  }

  // Mesaj silme
  window.deleteChatMessage = async function(messageId, ownerUsername) {
    if (username !== ownerUsername && username !== "bulutkeles") {
      alert("Yalnƒ±zca kendi mesajƒ±nƒ± silebilirsin.");
      return;
    }

    if (!confirm("Bu mesajƒ± silmek istediƒüine emin misin?")) return;

    await deleteDoc(doc(chatColRef, messageId));
  };
// üìå Mesaj sabitleme / kaldƒ±rma
window.togglePinChatMessage = async function(messageId, isPinned) {
  if (username !== "bulutkeles") {
    alert("Yalnƒ±zca oda sahibi mesaj sabitleyebilir.");
    return;
  }

  try {
    if (isPinned) {
      // zaten sabitliyse kaldƒ±r
      await updateDoc(doc(chatColRef, messageId), {
        pinned: false
      });
    } else {
      // √∂nce diƒüer sabitli mesajlarƒ± kaldƒ±r
      const qPinned   = query(chatColRef, where("pinned","==",true));
      const pinnedSnap = await getDocs(qPinned);
      await Promise.all(pinnedSnap.docs.map(d => updateDoc(d.ref, { pinned: false })));

      // sonra bu mesajƒ± sabitle
      await updateDoc(doc(chatColRef, messageId), {
        pinned: true,
        pinnedAt: serverTimestamp()
      });
    }
  } catch (e) {
    console.error("pin hata:", e);
    alert("Mesaj sabitlenirken bir hata olu≈ütu.");
  }
};

  function fillProfileForm() {
    if (!currentProfile) return;

    displayNameInput.value = currentProfile.displayName || "";
    titleInput.value       = currentProfile.title || "";

    const initials = (currentProfile.displayName || username)
      .split(" ")
      .map(p => p.charAt(0))
      .join("")
      .slice(0,2)
      .toUpperCase();

    if (currentProfile.coverUrl) {
      coverPreview.style.backgroundImage = `url(${currentProfile.coverUrl})`;
    } else {
      coverPreview.style.backgroundImage = "linear-gradient(135deg,#6366f1,#8b5cf6,#ec4899)";
    }

    if (currentProfile.avatarUrl) {
      avatarPreview.style.backgroundImage = `url(${currentProfile.avatarUrl})`;
      avatarPreview.textContent = "";
    } else {
      avatarPreview.style.backgroundImage = "none";
      avatarPreview.textContent = initials;
    }

    previewName.textContent  = currentProfile.displayName || username;
    previewTitle.textContent = currentProfile.title || "Morphera Admin";
  }
    function getInitials(nameOrUsername) {
    return (nameOrUsername || "")
      .split(" ")
      .map(p => p.charAt(0))
      .join("")
      .slice(0,2)
      .toUpperCase();
  }

import { onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

onSnapshot(notesColRef, (snap) => {
  snap.docChanges().forEach(ch => {
    if (ch.type === "modified" || ch.type === "added") {
      document.getElementById("notifDot").style.display = "inline-block";
    }
  });
});

  async function loadProfile() {
    const snap = await getDoc(authorDocRef);
    if (snap.exists()) {
      currentProfile = snap.data();
    } else {
      currentProfile = defaultProfile(username);
      await setDoc(authorDocRef, currentProfile, { merge:true });
    }
    fillProfileForm();
  }

  // Se√ßilen dosyayƒ± base64 Data URL'e √ßevir (Firestore'da string olarak tutacaƒüƒ±z)
  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload  = () => resolve(reader.result);
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(file);
    });
  }

  // ---- Profil Kaydet ----
  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      if (!currentProfile) {
        await loadProfile();
      }

      let avatarUrl = currentProfile.avatarUrl || "";
      let coverUrl  = currentProfile.coverUrl  || "";

      if (avatarFileInput.files[0]) {
        avatarUrl = await fileToDataUrl(avatarFileInput.files[0]);
      }
      if (coverFileInput.files[0]) {
        coverUrl = await fileToDataUrl(coverFileInput.files[0]);
      }

      currentProfile = {
        displayName: (displayNameInput.value || username).trim(),
        title: (titleInput.value || "").trim(),
        avatarUrl,
        coverUrl
      };

      await setDoc(authorDocRef, currentProfile, { merge:true });
      fillProfileForm();
      alert("Profil kaydedildi ‚úÖ");
    } catch (err) {
      console.error("Profil kaydedilirken hata:", err);
      alert("Profil kaydedilirken bir hata olu≈ütu. Konsolu kontrol et.");
    }
  });

  // ---- Yeni G√∂nderi ----
  postForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const text  = postTextInput.value.trim();
  const image = postImageInput.value.trim();
  const enableSchedule = document.getElementById("scheduleEnable").checked;

  if (!text) return;

  if (!currentProfile) { await loadProfile(); }

  const initials = (currentProfile.displayName || username)
    .split(" ").map(p => p.charAt(0)).join("").slice(0,2).toUpperCase();

  let payload = {
  authorKey: username,
  authorName: currentProfile.displayName || username,
  authorRole: currentProfile.title || "",
  authorInitials: initials,
  avatarUrl: currentProfile.avatarUrl || "",
  text,
  imageUrl: image || "",
  createdAt: serverTimestamp(),
  status: enableSchedule ? "scheduled" : "published"
};

if (enableSchedule) {
  let dateVal = document.getElementById("scheduleDate").value;
  let timeVal = document.getElementById("scheduleTime").value;

  if (!dateVal || !timeVal) {
    alert("Tarih ve saat se√ßmelisin!");
    return;
  }

  const fullDate = new Date(`${dateVal}T${timeVal}:00`);
  payload.status = "scheduled";
  payload.scheduledAt = Timestamp.fromDate(fullDate);
}


  


  await addDoc(notesColRef, payload);

  postTextInput.value = "";
  postImageInput.value = "";
  document.getElementById("scheduleEnable").checked = false;
  document.getElementById("scheduleFields").style.display = "none";

  await loadAdminPosts();
  await loadScheduledPosts();
  await loadAnalytics();

  alert(enableSchedule ? "G√∂nderi zamanlandƒ± ‚è∞" : "G√∂nderi payla≈üƒ±ldƒ± ‚úÖ");
});



  // ---- G√∂nderiler (sadece o admin) ----
  async function loadAdminPosts() {
    const q = query(notesColRef, orderBy("createdAt","desc"));
    const snap = await getDocs(q);

    const list = [];
    snap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.authorKey !== username) return;

      const date = data.createdAt?.toDate?.() || new Date();
      const ts = date.toLocaleString("tr-TR", {
        day:"2-digit", month:"2-digit", year:"numeric",
        hour:"2-digit", minute:"2-digit"
      });

     list.push(`
  <article class="admin-post-card">
    <div class="admin-post-meta">
      <span>${ts}</span>
      <span>‚ù§Ô∏è ${data.likeCount || 0} ¬∑ üí¨ ${data.commentCount || 0}</span>
    </div>

    <div class="admin-post-text">${(data.text || "").replace(/\\n/g,"<br>")}</div>

    <button class="btn-edit" onclick="openEditPost('${docSnap.id}','${data.text.replace(/'/g,"\\'")}','${data.imageUrl || ""}')">
      ‚úèÔ∏è D√ºzenle
    </button>

    <button class="btn-delete" onclick="deletePost('${docSnap.id}')">
      üóëÔ∏è Sil
    </button>
  </article>
`);

    });

    postList.innerHTML = list.join("") || "<p>Hen√ºz bir g√∂nderin yok.</p>";
  }

  // ---- Analytics ----
  async function loadAnalytics() {
    const snap = await getDocs(notesColRef);
    const notes = snap.docs;

    let totalPosts = notes.length;
    let totalLikes = 0;
    let totalComments = 0;

    await Promise.all(
      notes.map(async (docSnap) => {
        const id = docSnap.id;
        const likesSnap = await getDocs(collection(db,"morpheraNotes",id,"likes"));
        const commentsSnap = await getDocs(collection(db,"morpheraNotes",id,"comments"));
        totalLikes    += likesSnap.size;
        totalComments += commentsSnap.size;
      })
    );

    statPostsEl.textContent    = totalPosts;
    statLikesEl.textContent    = totalLikes;
    statCommentsEl.textContent = totalComments;
  }

  // ---- ƒ∞lk y√ºkleme ----
     // ---- ƒ∞lk y√ºkleme ----
    window.addEventListener("DOMContentLoaded", async () => {
    await loadProfile();
    await ensureDefaultChatMembers();
    await syncMyChatMemberDoc();

    await loadAdminPosts();
    await loadComments();
    await loadScheduledPosts();
    await loadAnalytics();

    // ‚≠ê Sohbet
    subscribeChatMembers();
    subscribeChatMessages();
    startPresenceHeartbeat();

    // ‚≠ê Durum se√ßici (online/me≈ügul/offline)
    const statusSelect = document.getElementById("chatStatusSelect");
    if (statusSelect) {
      // Varsa Firestore'daki son durumu oku
      try {
        const mySnap = await getDoc(doc(chatMembersRef, username));
        if (mySnap.exists()) {
          chatStatus = mySnap.data().status || "online";
          statusSelect.value = chatStatus;
        }
      } catch(e){}

      statusSelect.addEventListener("change", async (e) => {
        chatStatus = e.target.value;
        await updatePresence();
      });
    }
  });




  window.deletePost = async function(postId) {
  if (!confirm("Bu g√∂nderiyi silmek istediƒüine emin misin?")) return;

  try {
    // Alt koleksiyonlarƒ± (likes + comments) temizle
    const likesRef = collection(db, "morpheraNotes", postId, "likes");
    const commentsRef = collection(db, "morpheraNotes", postId, "comments");

    const likesSnap = await getDocs(likesRef);
    const commentsSnap = await getDocs(commentsRef);

    await Promise.all(likesSnap.docs.map(d => deleteDoc(d.ref)));
    await Promise.all(commentsSnap.docs.map(d => deleteDoc(d.ref)));

    // G√∂nderiyi sil
    await deleteDoc(doc(db, "morpheraNotes", postId));

    await loadAdminPosts();
    await loadAnalytics();

    alert("G√∂nderi ba≈üarƒ±yla silindi üóëÔ∏è");
  } catch (err) {
    console.error("Silme hatasƒ±:", err);
    alert("G√∂nderi silinirken bir hata olu≈ütu.");
  }
};
async function autoPublishScheduled() {
  const snap = await getDocs(notesColRef);
  const now = new Date();

  for (const d of snap.docs) {
    const post = d.data();

    // 1) Zamanlƒ± deƒüilse ge√ß
    if (post.status !== "scheduled") continue;

    // 2) scheduledAt yoksa ge√ß
    if (!post.scheduledAt) continue;

    // 3) Timestamp deƒüilse JS Date'e √ßevir
    let scheduledTime;
    try {
      if (post.scheduledAt.toDate) {
        scheduledTime = post.scheduledAt.toDate();
      } else {
        scheduledTime = new Date(post.scheduledAt);
      }
    } catch (e) {
      console.warn("Zamanlama okunamadƒ±:", e);
      continue;
    }

    // 4) Yayƒ±mlama zamanƒ± geldiyse publish et
    if (scheduledTime <= now) {
      await setDoc(doc(db, "morpheraNotes", d.id), {
        status: "published",
        publishedAt: serverTimestamp()
      }, { merge: true });
    }
  }
}


setInterval(autoPublishScheduled, 60000); // 1 dakikada bir kontrol
let editingPostId = null;

window.openEditPost = function(id, text, imageUrl) {
  editingPostId = id;
  document.getElementById("editText").value = text;
  document.getElementById("editImage").value = imageUrl;
  document.getElementById("editModal").style.display = "flex";
};

window.closeEditModal = function() {
  document.getElementById("editModal").style.display = "none";
};

window.saveEditPost = async function() {
  const text = document.getElementById("editText").value.trim();
  const imageUrl = document.getElementById("editImage").value.trim();

  await setDoc(doc(db,"morpheraNotes",editingPostId), {
    text,
    imageUrl
  }, { merge:true });

  closeEditModal();
  loadAdminPosts();
  alert("G√∂nderi g√ºncellendi ‚úèÔ∏è");
};
async function loadComments() {
  const snap = await getDocs(notesColRef);
  let out = [];

  for (const post of snap.docs) {
    const commentsSnap = await getDocs(collection(db, "morpheraNotes", post.id, "comments"));
    commentsSnap.forEach(c => {
      const d = c.data();
      out.push(`
        <div class="admin-post-card">
         <strong>${d.name}</strong>: ${d.comment}
          <button class="btn-delete" onclick="deleteComment('${post.id}', '${c.id}')">Sil</button>
        </div>
      `);
    });
  }
  document.getElementById("commentsList").innerHTML =
    out.length ? out.join("") : "<p>Hi√ß yorum yok.</p>";
}

window.deleteComment = async function(postId, commentId) {
  await deleteDoc(doc(db,"morpheraNotes",postId,"comments",commentId));
  loadComments();
};
async function loadCharts() {
  const snap = await getDocs(notesColRef);
  const dates = {};
  
  snap.forEach(d => {
    const t = d.data().createdAt?.toDate?.();
    if (!t) return;
    const key = t.toISOString().split("T")[0];
    dates[key] = (dates[key] || 0) + 1;
  });

  new Chart(document.getElementById("chartPosts"), {
    type: "line",
    data: {
      labels: Object.keys(dates),
      datasets: [{
        label: "G√ºnl√ºk g√∂nderiler",
        data: Object.values(dates),
        borderWidth: 3
      }]
    }
  });
}

window.addEventListener("DOMContentLoaded", loadCharts);
async function loadScheduledPosts() {
  const snap = await getDocs(notesColRef);
  let out = [];

  snap.forEach(d => {
    const post = d.data();
    if (post.status === "scheduled") {
      out.push(`
        <article class="admin-post-card">
          <div class="admin-post-meta">
            <span>${post.scheduledAt?.toDate().toLocaleString("tr-TR")}</span>
          </div>
          <div class="admin-post-text">${post.text}</div>
        </article>
      `);
    }
  });

  document.getElementById("scheduledList").innerHTML =
    out.length ? out.join("") : "<p>Zamanlanmƒ±≈ü g√∂nderi yok.</p>";
}

</script>



<div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);backdrop-filter:blur(8px);align-items:center;justify-content:center;">
  <div style="background:#0f172a;padding:20px;border-radius:18px;width:380px;">
    <h3 style="margin-top:0;color:#fff;">G√∂nderiyi D√ºzenle</h3>

    <textarea id="editText" style="width:100%;height:120px;margin-bottom:10px;"></textarea>
    <input id="editImage" type="text" style="width:100%;margin-bottom:12px;" placeholder="G√∂rsel URL">

    <button onclick="saveEditPost()" class="btn-primary">Kaydet</button>
    <button onclick="closeEditModal()" style="margin-left:10px;" class="btn-delete">Kapat</button>
  </div>
</div>

<audio id="chatSound" src="assets/sounds/chat-notif.mp3" preload="auto"></audio>

</body>
</html>
